<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<script src="../../node_modules/signature-mark/build/signature-mark.js"></script>

</head><body><dom-module id="junban-mobilekiosk-sign">
    <template>
        <style>
            :host {
                position: fixed;
                top: 0px;
                right: 0px;
                bottom: 0px;
                left: 0px;
            }
            #container {
                position: relative;
                height: 100%;
                width: 100%;
            }

            #fixed {
                position: fixed;
                top: 0px;
                right: 0px;
                bottom: 0px;
                left: 0px;
                height: 100%;
                width: 100%;
                background-color: orange;
                will-change: transform;
            }

            #toucharea {
                position: absolute;
                top: 6px;
                right: 6px;
                bottom: 70px;
                left: 6px;
                background-color: white;
                will-change: transform;
            }

            #clearBtn {
                position: absolute;
                left: 10px;
                bottom: 20px;
                z-index: 99999;
                border: var(--paper-grey-200) 1px solid;
                background-color: var(--paper-grey-100);
            }

            #submitBtn {
                position: absolute;
                right: 10px;
                bottom: 20px;
                z-index: 99999;
                padding-right: 45px;
                padding-left: 45px;
                background-color: var(--paper-green-500);
                color: white;
                will-change: transform;
            }


            /* For portrait, we want the sign area keep landscape view */

            @media screen and (orientation: portrait) {
                #container {
                    /* decrypt
                    transform: rotate(90deg);
                    transform-origin: 50vw 50vw;
                    */
                    height: 100vh;
                    width: 100vw;
                }
                #toucharea {
                    width: calc(100vw - 12px) ;
                    height: calc( 100 / 16 * 9vw);
                    top: 50vw;
                }
            }

            /* For landscape, we want the sign area work as normal*/

            @media screen and (orientation: landscape) {
            }
        </style>
        <div id="fixed"></div>
        <div id="container">
            <div id="toucharea"> </div>
            <paper-button id="clearBtn" on-tap="_clearTap">Refresh</paper-button>
            <paper-button id="submitBtn" on-transitionend="_submitTap">Submit</paper-button>
        </div>
    </template>
    <script>!function(){"use strict";Polymer({is:"junban-mobilekiosk-sign",behaviors:[Polymer.NeonSharedElementAnimatableBehavior,Polymer.IronResizableBehavior],listeners:{"iron-resize":"_onIronResize"},properties:{data:{type:Object,value:{},notify:!0},sharedElements:{type:Object,value:function(){return{ripple:this.$.fixed}}},animationConfig:{type:Object,value:function(){return{entry:[{name:"ripple-animation",id:"ripple",toPage:this},{name:"transform-animation",transformFrom:"translateY(150vh)",transformTo:"translateY(0vh)",node:this.$.toucharea,timing:{delay:350}},{name:"cascaded-animation",animation:"transform-animation",transformFrom:"translateY(60vh)",nodes:[this.$.submitBtn,this.$.clearBtn],timing:{delay:500}}],exit:[{name:"fade-out-animation",node:this.$.fixed,timing:{delay:350}},{name:"transform-animation",transformFrom:"none",transformTo:"translate(0px,-200vh) scale(0.9,1)",node:this.$.toucharea},{name:"cascaded-animation",animation:"transform-animation",transformTo:"translateY(60vh)",nodes:[this.$.submitBtn,this.$.clearBtn]}]}}},signatureMark:Object},_submitTap:function(t){this.saveSignature(),this._resetCanvas(),this.set("data.sign.signature",this.loadSignature()),this.fire("close-toucharea"),this.set("data.sign.complete",!0)},_clearTap:function(){this._resetCanvas()},_onIronResize:function(){this._resetCanvas()},_resetCanvas:function(){this.signatureMark&&(this.signatureMark.destroy(),this.$.toucharea.removeChild(this.signatureMark.canvas));var t=document.createElement("canvas");t.id="signatureCanvas",t.width=this.$.toucharea.offsetWidth,t.height=this.$.toucharea.offsetHeight,this.$.toucharea.appendChild(t),this.signatureMark=SignatureMark(t)},saveSignature:function(){var t=this._trim(this.signatureMark.canvas);t&&localStorage.setItem("signature",t.toDataURL("image/png"))},loadSignature:function(){return localStorage.getItem("signature")},_trim:function(t){var a,e,n,i=t.getContext("2d"),r=document.createElement("canvas").getContext("2d"),o=i.getImageData(0,0,t.width,t.height),s=o.data.length,h={top:null,left:null,right:null,bottom:null};for(a=0;a<s;a+=4)0!==o.data[a+3]&&(e=a/4%t.width,n=~~(a/4/t.width),null===h.top&&(h.top=n),null===h.left?h.left=e:e<h.left&&(h.left=e),null===h.right?h.right=e:h.right<e&&(h.right=e),null===h.bottom?h.bottom=n:h.bottom<n&&(h.bottom=n));var l=h.bottom-h.top,m=h.right-h.left;if(!m||!l)return!1;var u=i.getImageData(h.left,h.top,m,l);return r.canvas.width=m,r.canvas.height=l,r.putImageData(u,0,0),r.canvas}})}();</script>
</dom-module>
</body></html>