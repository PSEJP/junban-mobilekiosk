<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<script src="../../node_modules/signature-mark/build/signature-mark.js"></script>

<dom-module id="junban-mobilekiosk-sign">
    <template>
        <style>
            :host {
                position: fixed;
                top: 0px;
                right: 0px;
                bottom: 0px;
                left: 0px;
            }
            #container {
                position: relative;
                height: 100%;
                width: 100%;
            }

            #fixed {
                position: fixed;
                top: 0px;
                right: 0px;
                bottom: 0px;
                left: 0px;
                height: 100%;
                width: 100%;
                background-color: orange;
                will-change: transform;
            }

            #toucharea {
                position: absolute;
                top: 6px;
                right: 6px;
                bottom: 6px;
                left: 6px;
                background-color: white;
                will-change: transform;
            }

            #clearBtn {
                position: absolute;
                left: 10px;
                bottom: 20px;
                z-index: 99999;
                border: var(--paper-grey-200) 1px solid;
                will-change: transform;
            }

            #submitBtn {
                position: absolute;
                right: 10px;
                bottom: 20px;
                z-index: 99999;
                background-color: var(--paper-green-500);
                color: white;
                will-change: transform;
            }

            /* For portrait, we want the sign area keep landscape view */

            @media screen and (orientation: portrait) {
                #container {
                    /* decrypt
                    transform: rotate(90deg);
                    transform-origin: 50vw 50vw;
                    */
                    height: 100vh;
                    width: 100vw;
                }
                #toucharea {
                    width: calc(100vw - 12px) ;
                    height: calc( 100 / 16 * 9vw);
                    top: 50vw;
                }
            }

            /* For landscape, we want the sign area work as normal*/

            @media screen and (orientation: landscape) {
            }
        </style>
        <!-- TODO:要解決的問題
            *) 簽名模式要強制 landscape mode
            *) 簽名時 chrome 在瀏覽器上部向下滑動會跑出重整泡泡
        -->

        <div id="fixed"></div>
        <div id="container">
            <div id="toucharea">
            </div>
            <paper-button id="clearBtn" on-tap="_clearTap">Refresh</paper-button>
            <paper-button id="submitBtn" on-tap="_submitTap">Submit</paper-button>
        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'junban-mobilekiosk-sign',

                behaviors: [
                    Polymer.NeonSharedElementAnimatableBehavior,
                    Polymer.IronResizableBehavior
                ],

                listeners: {
                    'iron-resize': '_onIronResize'
                },

                properties: {
                    data: {
                        type: Object,
                        value: {},
                        notify: true
                    },

                    sharedElements: {
                        type: Object,
                        value: function () {
                            return {
                                'ripple': this.$.fixed
                            }
                        }
                    },

                    animationConfig: {
                        type: Object,
                        value: function () {
                            return {
                                'entry': [{
                                    name: 'ripple-animation',
                                    id: 'ripple',
                                    toPage: this
                                }, {
                                    name: 'transform-animation',
                                    transformFrom: 'translateY(150vh)',
                                    transformTo: 'translateY(0vh)',
                                    node: this.$.toucharea,
                                    timing: {
                                        delay: 350
                                    }
                                },
                                    {
                                        name: 'cascaded-animation',
                                        animation: 'transform-animation',
                                        transformFrom: 'translateY(60vh)',
                                        nodes: [this.$.submitBtn, this.$.clearBtn],
                                        timing: {
                                            delay: 500
                                        }
                                    }],
                                'exit': [{
                                    name: 'fade-out-animation',
                                    node: this.$.fixed,
                                    timing: {
                                        delay: 350
                                    }
                                }, {
                                    name: 'transform-animation',
                                    transformFrom: 'none',
                                    transformTo: 'translate(0px,-200vh) scale(0.9,1)',
                                    node: this.$.toucharea
                                },
                                    {
                                        name: 'cascaded-animation',
                                        animation: 'transform-animation',
                                        transformTo: 'translateY(60vh)',
                                        nodes: [this.$.submitBtn, this.$.clearBtn],
                                    }]
                            }
                        }
                    },

                    signatureMark: Object
                },
                _submitTap: function () {
                    this.saveSignature();
                    this._resetCanvas();
                    this.set('data.sign.signature', this.loadSignature());
                    this.fire('close-toucharea');
                    this.set('data.sign.complete', true )
                },
                _clearTap: function () {
                    this._resetCanvas();
                },
                _onIronResize: function () {
                    this._resetCanvas();
                },
                _resetCanvas: function() {
                    if (this.signatureMark) {
                        this.signatureMark.destroy();
                        this.$.toucharea.removeChild(this.signatureMark.canvas);
                    }

                    var canvas = document.createElement('canvas');
                    canvas.id = 'signatureCanvas';
                    canvas.width = this.$.toucharea.offsetWidth;
                    canvas.height = this.$.toucharea.offsetHeight;
                    this.$.toucharea.appendChild(canvas);
                    this.signatureMark = SignatureMark(canvas);
                },
                saveSignature: function () {
                    var trimmed = this._trim(this.signatureMark.canvas);
                    if (trimmed) {
                        localStorage.setItem('signature', trimmed.toDataURL('image/png'));
                    }
                },
                loadSignature: function () {
                    return localStorage.getItem('signature');
                },
                _trim: function (c) {
                    var ctx = c.getContext('2d'),
                            copy = document.createElement('canvas').getContext('2d'),
                            pixels = ctx.getImageData(0, 0, c.width, c.height),
                            l = pixels.data.length,
                            i,
                            bound = {
                                top: null,
                                left: null,
                                right: null,
                                bottom: null
                            },
                            x, y;

                    for (i = 0; i < l; i += 4) {
                        if (pixels.data[i+3] !== 0) {
                            x = (i / 4) % c.width;
                            y = ~~((i / 4) / c.width);

                            if (bound.top === null) {
                                bound.top = y;
                            }

                            if (bound.left === null) {
                                bound.left = x;
                            } else if (x < bound.left) {
                                bound.left = x;
                            }

                            if (bound.right === null) {
                                bound.right = x;
                            } else if (bound.right < x) {
                                bound.right = x;
                            }

                            if (bound.bottom === null) {
                                bound.bottom = y;
                            } else if (bound.bottom < y) {
                                bound.bottom = y;
                            }
                        }
                    }

                    var trimHeight = bound.bottom - bound.top,
                        trimWidth = bound.right - bound.left;

                    if (!trimWidth || !trimHeight) {
                        return false;
                    }

                    var trimmed = ctx.getImageData(bound.left, bound.top, trimWidth, trimHeight);

                    copy.canvas.width = trimWidth;
                    copy.canvas.height = trimHeight;
                    copy.putImageData(trimmed, 0, 0);

                    // open new window with trimmed image:
                    return copy.canvas;
                }
            });
        })();
    </script>
</dom-module>